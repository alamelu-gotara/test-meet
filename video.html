<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SyncLite Video Chat V2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div id="root" class="min-h-screen bg-gray-900 flex flex-col items-center p-4"></div>
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      // State
      const [peerId, setPeerId] = useState('');
      const [roomId, setRoomId] = useState('');
      const [status, setStatus] = useState('Initializing...');
      const [peers, setPeers] = useState([]);
      const [videos, setVideos] = useState([]); // {peerId, stream}
      const [joined, setJoined] = useState(false);

      // Refs
      const peerRef = useRef(null);
      const connectionsRef = useRef({});
      const callsRef = useRef({});
      const localStreamRef = useRef(null);

      // Get Peer ID on load
      useEffect(() => {
        const peer = new Peer();
        peerRef.current = peer;
        peer.on('open', id => {
          setPeerId(id);
          setStatus('Ready');
        });

        // Handle incoming connections (for signaling)
        peer.on('connection', conn => {
          conn.on('data', data => {
            if (data.type === 'join-room') {
              // Send list of peers in the room
              conn.send({ type: 'peer-list', peers: Object.keys(connectionsRef.current) });
              // Broadcast new peer to others
              Object.values(connectionsRef.current).forEach(c => {
                c.send({ type: 'new-peer', peerId: data.peerId });
              });
              // Add new peer to our list
              connectionsRef.current[data.peerId] = conn;
              setPeers(Object.keys(connectionsRef.current));
            } else if (data.type === 'new-peer') {
              if (!connectionsRef.current[data.peerId] && data.peerId !== peerId) {
                // Connect back to new peer
                joinPeer(data.peerId);
              }
            }
          });
        });

        // Handle incoming calls (for media)
        peer.on('call', call => {
          call.answer(localStreamRef.current);
          call.on('stream', remoteStream => {
            addVideo(call.peer, remoteStream);
          });
          callsRef.current[call.peer] = call;
        });

        return () => {
          peer.destroy();
          Object.values(callsRef.current).forEach(call => call.close());
        };
      }, []);

      // Add video stream to UI if not already present
      function addVideo(peerId, stream) {
        setVideos(vs => {
          if (vs.some(v => v.peerId === peerId)) return vs;
          return [...vs, { peerId, stream }];
        });
      }

      // Join a room
      async function joinRoom() {
        setStatus('Getting media...');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localStreamRef.current = stream;
        addVideo(peerId, stream);

        setStatus('Joining room...');
        setJoined(true);

        // Connect to the room host (roomId)
        if (roomId !== peerId) {
          const conn = peerRef.current.connect(roomId);
          conn.on('open', () => {
            connectionsRef.current[roomId] = conn;
            conn.send({ type: 'join-room', peerId });
          });
          conn.on('data', data => {
            if (data.type === 'peer-list') {
              data.peers.forEach(pid => {
                if (pid !== peerId && !connectionsRef.current[pid]) {
                  joinPeer(pid);
                }
              });
            } else if (data.type === 'new-peer') {
              if (!connectionsRef.current[data.peerId] && data.peerId !== peerId) {
                joinPeer(data.peerId);
              }
            }
          });
        }
      }

      // Connect to a peer and call them
      function joinPeer(pid) {
        const conn = peerRef.current.connect(pid);
        connectionsRef.current[pid] = conn;
        conn.on('open', () => {
          conn.send({ type: 'new-peer', peerId });
        });
        conn.on('data', data => {
          // Not needed for now
        });

        // Call with our media
        const call = peerRef.current.call(pid, localStreamRef.current);
        call.on('stream', remoteStream => {
          addVideo(pid, remoteStream);
        });
        callsRef.current[pid] = call;
      }

      // Mute/unmute local audio
      function toggleMute() {
        if (localStreamRef.current) {
          localStreamRef.current.getAudioTracks().forEach(track => {
            track.enabled = !track.enabled;
          });
        }
      }

      // Remove video when peer leaves (not implemented here, but can be added)

      return (
        <div className="w-full max-w-3xl mx-auto bg-gray-800 shadow-lg rounded p-6 mt-8">
          <h1 className="text-3xl font-bold text-purple-400 mb-4 text-center">SyncLite Video Chat V2</h1>
          <div className="bg-gray-700 p-3 rounded mb-4 text-sm space-y-1 text-white">
            <p><strong>Your Peer ID:</strong> {peerId}</p>
            <p><strong>Status:</strong> {status}</p>
            <p><strong>Connected Peers:</strong> {peers.join(', ')}</p>
          </div>
          {!joined && (
            <div className="mb-4 space-y-2">
              <input
                className="border p-2 w-full rounded"
                placeholder="Enter Room Host Peer ID (or your own to host)"
                value={roomId}
                onChange={e => setRoomId(e.target.value)}
              />
              <button
                onClick={joinRoom}
                className="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded w-full font-semibold"
                disabled={!peerId || !roomId}
              >
                {roomId === peerId ? 'Start Host to Chat' : 'Join Chat'}
              </button>
            </div>
          )}
          {joined && (
            <div className="flex flex-wrap gap-4 justify-center items-center">
              {videos.map(({peerId: pid, stream}) => (
                <div key={pid} className="flex flex-col items-center">
                  <video
                    autoPlay
                    playsInline
                    muted={pid === peerId}
                    ref={el => { if (el) el.srcObject = stream; }}
                    className="w-64 h-48 rounded shadow-lg bg-black"
                  />
                  <span className="text-gray-300 text-xs mt-1">{pid === peerId ? 'You' : pid}</span>
                </div>
              ))}
            </div>
          )}
          {joined && (
            <button
              onClick={toggleMute}
              className="mt-4 w-full py-2 px-4 rounded font-semibold bg-green-600 hover:bg-green-700 text-white"
            >
              Toggle Mute
            </button>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
