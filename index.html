<!-- SyncLite V20: Many-to-Many Audio + Single Screen Sharing -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SyncLite V30</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
      const [peerId, setPeerId] = useState('');
      const [peers, setPeers] = useState({});
      const [stream, setStream] = useState(null);
      const [screenStream, setScreenStream] = useState(null);
      const [isMuted, setIsMuted] = useState(false);
      const [remoteStreams, setRemoteStreams] = useState([]);
      const [screenSource, setScreenSource] = useState(null);
      const myVideo = useRef();
      const peer = useRef();
      const connections = useRef({});

      useEffect(() => {
        const p = new Peer();
        peer.current = p;

        p.on('open', id => {
          setPeerId(id);
        });

        p.on('call', call => {
          call.answer(stream);
          call.on('stream', remote => handleNewRemoteStream(call.peer, remote));
        });

        return () => p.destroy();
      }, [stream]);

      useEffect(() => {
        if (myVideo.current && stream) {
          myVideo.current.srcObject = stream;
        }
      }, [stream]);

      const startMic = async () => {
        const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setStream(micStream);
      };

      const connectToPeer = (remoteId) => {
        if (!stream || !remoteId || remoteId === peerId) return;
        const call = peer.current.call(remoteId, stream);
        call.on('stream', remote => handleNewRemoteStream(remoteId, remote));
        connections.current[remoteId] = call;
      };

      const handleNewRemoteStream = (peerId, remote) => {
        setRemoteStreams(prev => {
          const filtered = prev.filter(item => item.peerId !== peerId);
          return [...filtered, { peerId, stream: remote }];
        });
      };

      const toggleMute = () => {
        if (!stream) return;
        const enabled = !isMuted;
        stream.getAudioTracks().forEach(track => (track.enabled = enabled));
        setIsMuted(!enabled);
      };

      const shareScreen = async () => {
        const sStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        setScreenStream(sStream);
        setScreenSource(peerId);

        Object.keys(connections.current).forEach(remoteId => {
          const call = peer.current.call(remoteId, sStream);
          call.on('stream', remote => {
            // Skip: we donâ€™t play it here
          });
        });

        sStream.getVideoTracks()[0].addEventListener('ended', () => {
          setScreenStream(null);
          setScreenSource(null);
        });
      };

      return (
        <div className="max-w-2xl mx-auto bg-white p-6 rounded shadow-md space-y-4">
          <h1 className="text-2xl font-bold text-purple-600 text-center">SyncLite V30</h1>
          <p className="text-sm text-center">Your ID: <code className="bg-gray-100 px-2 py-1 rounded">{peerId}</code></p>

          <div className="flex gap-2">
            <button onClick={startMic} className="bg-blue-600 text-white px-4 py-2 rounded">Start Mic</button>
            <button onClick={shareScreen} className="bg-purple-600 text-white px-4 py-2 rounded">Share Screen</button>
            <button onClick={toggleMute} className={`px-4 py-2 rounded text-white ${isMuted ? 'bg-green-600' : 'bg-red-600'}`}>
              {isMuted ? 'Unmute' : 'Mute'}
            </button>
          </div>

          <div className="flex items-center space-x-2 mt-2">
            <input type="text" id="peerInput" className="border px-2 py-1 flex-1 rounded" placeholder="Peer ID to connect" />
            <button onClick={() => connectToPeer(document.getElementById('peerInput').value)} className="bg-gray-800 text-white px-4 py-1 rounded">Connect</button>
          </div>

          <h2 className="text-lg font-semibold mt-4">My Audio</h2>
          <audio ref={myVideo} autoPlay muted controls className="w-full" />

          <h2 className="text-lg font-semibold mt-4">Remote Audio</h2>
          {remoteStreams.map(({ peerId, stream }) => (
            <div key={peerId} className="mb-2">
              <p className="text-sm font-medium">From: {peerId}</p>
              <audio autoPlay controls srcObject={stream} className="w-full"
                     ref={el => el && (el.srcObject = stream)} />
            </div>
          ))}

          {screenStream && (
            <div className="mt-4">
              <h2 className="text-lg font-semibold">You are sharing screen</h2>
              <video autoPlay playsInline muted controls className="w-full max-h-[300px]"
                     srcObject={screenStream}
                     ref={el => el && (el.srcObject = screenStream)} />
            </div>
          )}

          {!screenStream && screenSource && (
            <div className="mt-4">
              <h2 className="text-lg font-semibold">Watching screen shared by {screenSource}</h2>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
