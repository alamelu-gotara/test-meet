<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SyncLite - V34 - Many-to-Many</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-3xl mx-auto space-y-4">
    <h1 class="text-2xl font-bold text-center text-purple-600">SyncLite â€“ V34 - Many-to-Many Share</h1>

    <div class="space-y-2">
      <label class="block font-medium">Your Peer ID:</label>
      <input id="my-id" class="w-full p-2 border rounded" readonly />
    </div>

    <div class="space-y-2">
      <label class="block font-medium">Connect to Peer ID:</label>
      <input id="peer-id-input" class="w-full p-2 border rounded" />
      <button id="connect-btn" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">Connect</button>
    </div>

    <div class="flex space-x-2">
      <button id="toggle-mic" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">Mute Mic</button>
      <button id="share-screen" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Share Screen</button>
    </div>

    <div id="videos" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6"></div>
  </div>

  <script>
    const myIdInput = document.getElementById("my-id");
    const peerIdInput = document.getElementById("peer-id-input");
    const connectBtn = document.getElementById("connect-btn");
    const toggleMicBtn = document.getElementById("toggle-mic");
    const shareScreenBtn = document.getElementById("share-screen");
    const videosDiv = document.getElementById("videos");

    const peer = new Peer();
    const connections = {}; // peerId -> conn
    const calls = {}; // peerId -> call
    let localMicTrack = null;
    let localStream = null;
    let isMuted = false;

    const addVideoStream = (stream, label = "") => {
      const video = document.createElement("video");
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      video.className = "rounded shadow w-full";
      if (label) {
        const container = document.createElement("div");
        const name = document.createElement("p");
        name.className = "text-sm text-gray-600 mb-1";
        name.innerText = label;
        container.appendChild(name);
        container.appendChild(video);
        videosDiv.appendChild(container);
      } else {
        videosDiv.appendChild(video);
      }
    };

    async function getMicStream() {
      const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localMicTrack = micStream.getAudioTracks()[0];
      return micStream;
    }

    function updateMicState() {
      if (localMicTrack) {
        localMicTrack.enabled = !isMuted;
      }
      toggleMicBtn.textContent = isMuted ? "Unmute Mic" : "Mute Mic";
      toggleMicBtn.classList.toggle("bg-green-600", !isMuted);
      toggleMicBtn.classList.toggle("bg-red-600", isMuted);
    }

    toggleMicBtn.onclick = () => {
      isMuted = !isMuted;
      updateMicState();
    };

    shareScreenBtn.onclick = async () => {
      const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      const combinedStream = new MediaStream([screenStream.getVideoTracks()[0]]);
      if (localMicTrack) combinedStream.addTrack(localMicTrack);

      addVideoStream(combinedStream, "Your Screen");

      // Re-call all peers with new screen+audio stream
      for (const peerId of Object.keys(connections)) {
        const call = peer.call(peerId, combinedStream);
        calls[peerId] = call;
        call.on("stream", stream => {
          addVideoStream(stream, "Screen from " + peerId);
        });
      }

      screenStream.getVideoTracks()[0].addEventListener("ended", () => {
        console.log("Screen sharing stopped");
      });
    };

    connectBtn.onclick = async () => {
      const remoteId = peerIdInput.value.trim();
      if (!remoteId || remoteId === peer.id) return;
      const conn = peer.connect(remoteId);
      connections[remoteId] = conn;

      conn.on("open", async () => {
        if (!localStream) {
          const micStream = await getMicStream();
          localMicTrack = micStream.getAudioTracks()[0];
          localStream = micStream;
          updateMicState();
        }

        const call = peer.call(remoteId, localStream);
        calls[remoteId] = call;
        call.on("stream", stream => {
          addVideoStream(stream, "From " + remoteId);
        });
      });

      peerIdInput.value = "";
    };

    peer.on("open", async id => {
      myIdInput.value = id;
      const micStream = await getMicStream();
      localMicTrack = micStream.getAudioTracks()[0];
      localStream = micStream;
      updateMicState();
    });

    peer.on("call", call => {
      call.answer(localStream);
      calls[call.peer] = call;
      call.on("stream", stream => {
        addVideoStream(stream, "From " + call.peer);
      });
    });

    peer.on("connection", conn => {
      connections[conn.peer] = conn;
    });
  </script>
</body>
</html>
